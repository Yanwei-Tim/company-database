<div id="meteorologicalOperate" class="easyui-layout" style="overflow:auto;">
	<div data-options="region:'north',height:45,border:false">
        <!--保存按钮-->
        <div id="btnOperaDiv" style="margin: 8px;">
            <a id="saveAndNext" class="easyui-linkbutton button-right button-save button-main" data-options="iconCls:'icon-right'" cy-click="saveAndNext">保存并下一步</a>
            <a id="save" class="easyui-linkbutton button-save button-main" data-options="iconCls:'icon-save'"  cy-click="saveOnly">保存</a>
            <a id="destroyTab" class="easyui-linkbutton" data-options="iconCls:'icon-cancel'" cy-click="destroyTab1">关闭</a>
        </div>
    </div>
    <div data-options="region:'center',border:false">
        <form cy-form="formData" id="form">
            <div class="searchPanel">
                <div class="panel_title">基本信息</div>
                <div class="table">
                    <div class="tr">
                        <div class="th">设备编号：</div>
                        <div class="td">
                        	<input class="easyui-textbox" name="deviceSysNbr" id="deviceSysNbr" data-options="prompt:'选择机构后可自动生成',validType:['fixedLength[18]','numOrLetter'],required:true" />
                        </div>
	                    <div class="th">设备名称：</div>
                        <div class="td">
                            <input class="easyui-textbox" name="deviceName" id="deviceName" data-options="prompt:'选择点位后可自动生成',validType:['length[0,128]','blank'],required:true"/>
                        </div>
                        <div class="th">设备品牌：</div>
                        <div class="td">
                            <input class="easyui-textbox" id="deviceBrand" name="deviceBrand" validType="length[0,16]"/>
                        </div>
                   	 </div>
                   	 <div class="tr">
                        <div class="th">所属机构：</div>
                        <div class="td">
                            <input id="orgId" class="cy-org-radio" after-change="getSiteAndDeviceByOrg" name="orgId" style="width: 180px;" data-options="required:true"/>
                        </div>
                        <div class="th">所属合同：</div>
                        <div class="td">
                            <input class="easyui-combobox" id="contract" name="contractId" data-options="valueField:'id',textField:'text'" style="width:150px"/>
                        	<a class="easyui-linkbutton button-add" data-options="iconCls:'icon-add-solid',plain:true,selected:true" cy-click="addContract"></a>
                        </div>
	                    <div class="th">所属厂商：</div>
                        <div class="td">
                            <input id="contractor" class="easyui-combobox" name="contractorId" data-options="valueField:'contractorId',textField:'contractorName',required:true" style="width:150px"/>
                            <a class="easyui-linkbutton button-add" data-options="iconCls:'icon-add-solid',plain:true,selected:true" cy-click="addCompany"></a>
                        </div>
                   	 </div>
                   	 
					<div class="tr">
						<div class="th">所在道路：</div>
						<div class="td">
							<input class="cy-road-radio" after-change="getSiteByRoad" name="roadId"
								style="width: 180px;" id="roadId" filter="getRoadByOrg" />
						</div>
						<div class="th">所在点位：</div>
						<div class="td">
							<input id="siteId" class="easyui-combobox" name="siteId"
								style="width: 150px"
								data-options="valueField:'siteId',textField:'siteName',required:true" /> <a
								class="easyui-linkbutton button-add"
								data-options="iconCls:'icon-add-solid',plain:true,selected:true"
								cy-click="addSite"></a>
						</div>
						<div class="th">方向名称：</div>
						<div class="td">
							<input class="easyui-combobox" id="derictionName" name="sectionIdList"
								data-options="valueField:'id',textField:'text',multiple:true" />
						</div>
					</div>
					<div class="tr">
                        <div class="th">建设归属：</div>
                        <div class="td" style="width: 180px;">
                            <input type="radio" name="ownership" value="1" style="width: 10px" checked="checked"/>交警
                            <input type="radio" name="ownership" value="2" style="width: 10px"/>公安
                            <input type="radio" name="ownership" value="3" style="width: 10px"/>其他
                        </div>
                        <div class="th">安装方式：</div>
                        <div class="td">
                            <input type="radio" name="mountingFacilityType" value="1" style="width: 10px" checked="checked"/>L杆
                            <input type="radio" name="mountingFacilityType" value="2" style="width: 10px"/>M型龙门架
                            <input type="radio" name="mountingFacilityType" value="3" style="width: 10px"/>N型龙门架
                            <input type="radio" name="mountingFacilityType" value="4" style="width: 10px"/>F杆
                            <input type="radio" name="mountingFacilityType" value="5" style="width: 10px"/>其他
                        </div> 
                   	 </div>
                   	 <div class="tr">
                   	  <div class="th">安装人：</div>
                        <div class="td">
                            <input class="easyui-textbox" name="installBy" data-options="validType:'length[0,16]'"/>
                        </div>
                   	 	<div class="th">安装日期：</div>
                        <div class="td">
                            <input class="easyui-datebox" name="installDate" validType="date"/>
                        </div>
                        <div class="th">备注：</div>
                        <div class="td">
                            <input class="easyui-textbox" data-options="validType:'length[0,16]',multiline:true" name="remark" style="height:40px"/>
                        </div>
                   	 </div>
                </div>
            </div>
            <div class="searchPanel">
                <div class="panel_title">联网接入</div>
                <div class="table">
                    <div class="tr">
                        <div class="th">联网类型：</div>
                        <div class="td" style="width: 220px;">
                            <input type="radio" name="networkType" value="1" style="width: 10px" checked="checked"/>公安网
                            <input type="radio" name="networkType" value="2" style="width: 10px"/>专网
                            <input type="radio" name="networkType" value="3" style="width: 10px"/>互联网
                            <input type="radio" name="networkType" value="4" style="width: 10px"/>未联网
                        </div>
                        <div class="th">供电类型：</div>
                        <div class="td" style="width: 160px;">
                            <input type="radio" name="powerType" value="1" style="width: 10px" checked="checked"/>农电
                            <input type="radio" name="powerType" value="2" style="width: 10px"/>市电
                            <input type="radio" name="powerType" value="3" style="width: 10px"/>太阳能
                        </div>
                        <div class="th">传输方式：</div>
                        <div class="td" style="width: 180px;">
                            <input type="radio" name="transmissionMode" value="1" style="width: 10px" checked="checked"/>专线
                            <input type="radio" name="transmissionMode" value="2" style="width: 10px"/>3G
                            <input type="radio" name="transmissionMode" value="3" style="width: 10px"/>4G
                        </div>
                    </div>
                    <div class="tr">
                    	<div class="th">接入方式：</div>
                        <div class="td" style="width:220px">
                            <input type="radio" name="safeConnectMeans" value="1" style="width: 10px" checked="checked"/>安全接入平台
                            <input type="radio" name="safeConnectMeans" value="2" style="width: 10px"/>双网卡
                            <input type="radio" name="safeConnectMeans" value="3" style="width: 10px"/>直接接入
                        </div>
                        <div class="th">网络带宽：</div>
                        <div class="td">
                            <input class="easyui-textbox" name="bandwidth" data-options="validType:'length[0,32]'" style="width:160px"/>
                        </div>
                        <div class="th">接入平台：</div>
                        <div class="td">
                            <input id="serverPlatId" name="serverPlatId" data-options="valueField:'id',textField:'text'" style="width:150px"/>
                        	<a class="easyui-linkbutton button-add" data-options="iconCls:'icon-add-solid',plain:true,selected:true" cy-click="addPlatform"></a>
                        </div>
                    </div>
                    <div class="tr">
                    	<div class="th">设备IP：</div>
                        <div class="td" style="width:220px">
                            <input class="easyui-textbox" name="deviceIp" validType="ip"/>
                        </div>
                        <div class="th">端口号：</div>
                        <div class="td">
                            <input class="easyui-textbox" data-options="validType:['length[0,20]','number']" name="devicePort" style="width:160px"/>
                        </div>
                        <div class="th">出厂序列号：</div>
                        <div class="td">
                            <input class="easyui-textbox" data-options="validType:'length[0,32]'" name="manufactureSn"/>
                        </div>
                    </div>
                    <div class="tr">
                 		<div class="th">软件版本：</div>
                        <div class="td" style="width:220px">
                            <input class="easyui-textbox" data-options="validType:'length[0,16]'" name="softwareVersion"/>
                        </div>
                        <div class="th">SIM卡号：</div>
                        <div class="td">
                            <input class="easyui-textbox" data-options="validType:['length[0,32]','number']" name="simNbr" style="width:160px"/>
                        </div>
                        <div class="th">用户名：</div>
                        <div class="td">
                            <input class="easyui-textbox" data-options="validType:'length[0,16]'" name="userName"/>
                        </div>
                 	</div>
                 	 <div class="tr">
                        <div class="th">密码：</div>
                        <div class="td">
                            <input class="easyui-textbox" type="password" name="password"/>
                        </div>
                 	</div>
                 </div>
            </div>
            <div class="searchPanel">
                <div class="panel_title">功能与参数</div>
                <div class="table">
                	<div class="tr" style="margin-left: 10px;"> 
                        <div class="th" style="width: 120px;margin-left: 20px;">
                            <input type="checkbox" cy-change="isWeatherSupportChecked" style="width: 10px" id="isWeatherSupport" name="isWeatherSupport" value="0"/>支持气象采集
                        </div>
                        <div class="td" style="width: 120px;margin-left: 20px;">
                            <input type="checkbox" cy-change="isVisibilitySupportChecked" style="width: 10px" id="isVisibilitySupport" name="isVisibilitySupport" value="0"/>支持能见度采集
                        </div> 
                        <div class="td" style="width: 90px;margin-left: 20px;">
                            <input type="checkbox" cy-change="isRoadsensorSupportChecked" style="width: 10px" id="isRoadsensorSupport" name="isRoadsensorSupport" value="0"/>支持路感
                        </div>
                    </div>
                	<div class="tr">
                		<div class="th" style="width:100px">关联诱导屏：</div>
                        <div class="td">
                            <input class="easyui-combobox" id="ydp" name="relatedLedId" data-options="valueField:'id',textField:'text',multiple:true"/>
                        </div>
                        <div class="th" style="width:80px">关联视频：</div>
                        <div class="td">
                            <input class="easyui-combobox videoCombox" id ="sp" name="relatedVideoId" data-options="valueField:'id',textField:'text',multiple:true"/>
                        </div>
	                    <div class="th" style="width:110px">关联固定测速设备：</div>
	                    <div class="td">
	                        <input class="easyui-combobox" id = "cs" name="relatedSpeedDeviceId" data-options="valueField:'id',textField:'text',multiple:true"/>
	                    </div>
	                </div>
	                <div class="tr">
	                    <div class="th" style="width:100px" >关联可变限速牌：</div>
	                    <div class="td">
	                        <input class="easyui-combobox" id="xsp" name="relatedVariableSpeed" data-options="valueField:'id',textField:'text',multiple:true"/>
	                    </div>
	                </div>
                </div>
            </div>

        </form>
     </div>  
</div>
<script type="text/javascript">
	InitPage(["remark","deviceSysConfigTabs","saveData","destroyTab1","deviceInfoDto","whichName"],function($scope){
		var oldDeviceSysNbr = "";
		$scope.load = function(){
			//编辑设备时对不同状态的设备不予编辑的选项
			if($scope.deviceInfoDto){
				if($scope.deviceInfoDto.useStatusFlag == 1 || $scope.deviceInfoDto.useStatusFlag == 2  || $scope.deviceInfoDto.useStatusFlag == 3){//启用，停用，报废的设备
					$scope.$("#orgId").textbox("disable");
					$scope.$("#roadId").textbox("disable");
					$scope.$("#siteId").combobox("disable");
					$scope.$("#derictionName").combobox("disable");
				}
			}
			queryContract();
			//删除对象字段值为null的字段
			var deviceInfoDto = $scope.deviceInfoDto;
			oldDeviceSysNbr = deviceInfoDto.deviceSysNbr;
            for(var key in deviceInfoDto){
            	if(deviceInfoDto[key] == null){
            		delete deviceInfoDto[key];
            	}
            }
            $scope.formData = deviceInfoDto ? deviceInfoDto : {} ;
            $scope.$updateDom("formData");  //将formData中的数据加载到页面
            if ($scope.formData.isWeatherSupport == "1") {
				$scope.$("#isWeatherSupport").get(0).checked = true;
				$scope.isWeatherSupportChecked();
			}else{
            	$scope.$("#isWeatherSupport").get(0).checked = false;
            }
			if($scope.formData.isVisibilitySupport == "1"){
				$scope.$("#isVisibilitySupport").get(0).checked = true;
				$scope.isVisibilitySupportChecked();
			}else{
	            	$scope.$("#isVisibilitySupport").get(0).checked = false;
	            }
			if($scope.formData.isRoadsensorSupport == "1"){
				$scope.$("#isRoadsensorSupport").get(0).checked = true;
				$scope.isRoadsensorSupportChecked();
			}else{
	            	$scope.$("#isRoadsensorSupport").get(0).checked = false;
	            }
            //根据道路加载点位
			$scope.getSiteByRoad = function(){
				$scope.$("#siteId").combobox("clear");
				var roadId = $scope.$("#roadId").textbox("getValue"); 
				var orgId = $scope.$("#orgId").textbox("getValue");
				var datas = {};//存机构或道路
				datas.roadId = roadId;
				datas.orgId = orgId;
				$scope.$ajaxRequest({
	        		url: $scope.$restRoot+'device/site/querySites',
	        		params: datas,
	        		success: function(data){
	        			if(data.length != 0){
	        				$scope.$("#siteId").combobox("loadData",data);
	        			}else{
							$scope.$("#siteId").combobox("loadData",[]);//加载点位为空
    					}
	        		},
	        		fail: function(errMsg){
	        			$.messager.alert("提示","点位加载失败！");
	        		}	
	        	});	
			};
		};
		//加载combobox 
		function LoadCombobox(id, data) {
			$scope.$(id).combobox({
		        url: null,
		        valueField: 'id',
		        textField: 'text',
		        editable: false,
		        data: data
		    });
		}
		//查询合同信息加载
        function queryContract(){
        	$scope.$ajaxRequest({
                url:$scope.$restRoot+"device/contractManage/queryAllContract",
                params:{},
                method:"post",
                success:function(data){
                    $scope.$("#contract").combobox("loadData",data);
                    queryContractor();
                },
                fail:function(errMsg){
                    $.messager.alert("提示","初始化合同失败，请重新打开此页面！");
                }
            });
        }
        //查询厂商信息加载
        function queryContractor(){
        	$scope.$ajaxRequest({
                url:$scope.$restRoot+"device/companyManage/queryCompany",
                params:{},
                method:"post",
                success:function(data){
                    $scope.$("#contractor").combobox("loadData",data);
                    queryAccessPlatform();
                },
                fail:function(errMsg){
                    $.messager.alert("提示","初始化厂商失败，请重新打开此页面！");
                }
            });
        }
        //查询接入平台加载
        function queryAccessPlatform(){
        	$scope.$ajaxRequest({
                url:$scope.$restRoot+"device/monitorPlatformManage/queryMonitorAndPlatform",
                params:{},
                method:"post",
                success:function(data){
                	//判断是否选择的是接入平台
					$scope.$('#serverPlatId').combotree({
						data : data,
						onChange : function(newValue, oldValue) {
							var t = $scope.$('#serverPlatId').combotree('tree');// 获取树对象
							var node = t.tree('getSelected');//获取选中的节点
							if(node != null && node.attribute.type == 'monitor'){
								$.messager.alert("提示","请选择接入平台！");
								$scope.$('#serverPlatId').combotree('clear');//清除combotree组件中的值
								return false;
							}
						}
					});
                },
                fail:function(errMsg){
                    $.messager.alert("提示","初始化接入平台失败，请重新打开此页面！");
                }
            });
        }
        //更新多选的信息ID列表
        function updateFormIdList(){
        	
        	$scope.formData.deviceType = "05";//气象设备
        	
        	if($scope.$("#derictionName").combobox("getValues").length != 0){
            	var sectionIdListStr = $scope.$("#derictionName").combobox("getValues").join(",");
            	$scope.formData.sectionIdList = sectionIdListStr;
            }
            if($scope.$("#xsp").combobox("getValues").length != 0){
            	var relatedVariableSpeedStr = $scope.$("#xsp").combobox("getValues").join(",");
            	$scope.formData.relatedVariableSpeed =relatedVariableSpeedStr;
            }
            if($scope.$("#ydp").combobox("getValues").length != 0){
            	var relatedLedIdStr = $scope.$("#ydp").combobox("getValues").join(",");
            	$scope.formData.relatedLedId = relatedLedIdStr;
            }
            if($scope.$("#cs").combobox("getValues").length != 0){
            	var relatedSpeedDeviceIdStr = $scope.$("#cs").combobox("getValues").join(",");
            	$scope.formData.relatedSpeedDeviceId = relatedSpeedDeviceIdStr;
            }
            if($scope.$("#sp").combobox("getValues").length != 0){
            	var relatedSpeedDeviceIdStr = $scope.$("#sp").combobox("getValues").join(",");
            	$scope.formData.relatedVideoId = relatedSpeedDeviceIdStr;
            }
            
            $scope.formData.isWeatherSupport =($("input[name = isWeatherSupport]:checked").val()!=undefined?
            		$("input[name = isWeatherSupport]:checked").val():"0");
            $scope.formData.isVisibilitySupport = ($("input[name = isVisibilitySupport]:checked").val()!=undefined?
            		$("input[name = isVisibilitySupport]:checked").val():"0");
            $scope.formData.isRoadsensorSupport = ($("input[name = isRoadsensorSupport]:checked").val()!=undefined?
            		$("input[name = isRoadsensorSupport]:checked").val():"0");
        }
		//保存气象设备，关闭窗口
		$scope.saveOnly = function(){
			if($scope.$("#derictionName").combobox("getValues").length != 0){
            	var sectionIdListStr = $scope.$("#derictionName").combobox("getValues").join(",");
            	$scope.$("#derictionName").combobox("setValue",sectionIdListStr);
            }
             $scope.$(".videoCombox").each(function(){
           		if($(this).length != 0){
	            	var relatedVideoListStr = $(this).combobox("getValues").join(",");
	            	$(this).combobox("setValue",relatedVideoListStr);
	            }
            });
           	if($scope.$("#ydp").combobox("getValues").length !=0){
            	var relatedLedIdStr = $scope.$("#ydp").combobox("getValues").join(",");
            	$scope.$("#ydp").combobox("setValue",relatedLedIdStr);
            }
            if($scope.$("#cs").combobox("getValues").length !=0){
            	var relatedSpeedDeviceIdStr = $scope.$("#cs").combobox("getValues").join(",");
            	$scope.$("#cs").combobox("setValue",relatedSpeedDeviceIdStr);
            }
            if($scope.$("#xsp").combobox("getValues").length !=0){
            	var relatedVariableSpeedStr = $scope.$("#xsp").combobox("getValues").join(",");
            	$scope.$("#xsp").combobox("setValue",relatedVariableSpeedStr);
            }
			if($scope.$("#form").form("validate")){
            	$scope.$updateData("formData");
            	updateFormIdList();
            	trimObject($scope.formData);//对对象中的每个元素进行trim操作var data = 
            	$scope.formData.deviceSysNbr = $scope.$("#deviceSysNbr").textbox("getValue");
				$scope.formData.deviceName = $scope.$("#deviceName").textbox("getValue");
            	//设备基本信息保存到数据库todo
            	$scope.saveData($scope.formData);
            }
            
		};
		//保存气象设备，进入下一步
		$scope.saveAndNext = function(){
			if($scope.remark=="ADD" && $scope.$("#form").form("validate")){
            	$scope.$updateData("formData"); 
            	updateFormIdList();
            	trimObject($scope.formData);//对对象中的每个元素进行trim操作
            	$scope.formData.deviceSysNbr = $scope.$("#deviceSysNbr").textbox("getValue");
				$scope.formData.deviceName = $scope.$("#deviceName").textbox("getValue");
            	//设备基本信息保存到数据库todo
            	$scope.$ajaxRequest({
	                url: $scope.$restRoot + "device/deviceConfig/addDeviceInfo",
	                params: $scope.formData,
	                method: "post",
	                success: function(data){
	                	if(data != "nbrError"){
							$.messager.alert("提示", "添加基本信息成功！");
							$scope.$(".button-save").linkbutton('disable').removeAttr('cy-click');
						    $scope.$setParam("deviceId3",data);//传递新增设备的ID
		                    //检定tab页可用
		                    $scope.deviceSysConfigTabs.tabs('enableTab', 3);
						}else if(data == "nbrError"){
							$.messager.alert("提示","设备编号已存在，请重新输入！");
    	       	   	   		return false;
    	       	   	   	}
	                },
	                fail: function(errMsg){
	                    $.messager.alert("提示","添加失败！");
	                }
	            });
            }
			else if($scope.remark=="update" && $scope.$("#form").form("validate")){
				updateFormIdList();
				trimObject($scope.formData);//对对象中的每个元素进行trim操作
            	$scope.formData.oldDeviceSysNbr = oldDeviceSysNbr;//编辑时原先的设备编号
            	$scope.$ajaxRequest({
            		url: $scope.$restRoot+'device/deviceConfig/updateDeviceInfo',
            		params: $scope.formData,
            		method: 'post',
            		success: function(data){
            			if(data == 1){
							$.messager.alert("提示","修改成功!");
						}else if(data == 0){
							$.messager.alert("提示","设备编号已存在，请重新输入！");
       	   	   				return false;
						}
            		},
            		fail: function(errMsg){
            			$.messager.alert("提示","修改失败!");
            		}
            	});
			}
		};
		/**
         * 新增合同
         */
        $scope.addContract = function(){
            //新建新增合同弹出框
            $scope.$openDialog("addDialog",{
                title : "新增合同信息",
                width : 600,
                height : 480,
                href : "tpls/deviceManage/informationManage/contract-operate.html"
            },true);
            /**
             * 新增保存
             */
            $scope.$setParam("saveData",function(data) {
                //后台保存数据
                $scope.$ajaxRequest({
                    url: $scope.$restRoot+"device/contractManage/addContract",
                    params: data,
                    method: "post",
                    success: function(data){
                        $scope.$getDialog("addDialog").dialog("close");
                        $scope.$ajaxRequest({
			                url:$scope.$restRoot+"device/contractManage/queryAllContract",
			                params:{},
			                method:"post",
			                success:function(data){
			                    $scope.$("#contract").combobox("loadData",data);
			                },
			                fail:function(errMsg){
			                    $.messager.alert("提示","初始化合同失败！");
			                }
			            });
                    },
                    fail: function(errMsg){
                        $.messager.alert("提示", errMsg + ",添加失败！");
                    }
                });
            });
        };
         /**
         * 新增厂商
         */
        $scope.addCompany = function(){
            //建立弹出框
            $scope.$openDialog("addDialog",{
                title : "新增厂商信息",
                width : 450,
                height : 380,
                href : "tpls/deviceManage/informationManage/company-operate.html"
            },true);
            /**
             * 新增保存
             */
            $scope.$setParam("saveData",function(data) {
                //后台保存数据
                $scope.$ajaxRequest({
                    url: $scope.$restRoot + "device/companyManage/addCompany",
                    params: data,
                    method: "post",
                    success: function(data){
                        $scope.$getDialog("addDialog").dialog("close");
                        $scope.$ajaxRequest({
				            url:$scope.$restRoot + "device/companyManage/queryCompany",
				            params:{},
				            method:"post",
				            success:function(data){
				                $scope.$("#contractor").combobox("loadData",data);
				            },
				            fail:function(errMsg){
				                $.messager.alert("提示","初始化厂商失败！");
				            }
				        });
                    },
                    fail: function(errMsg){
                        $.messager.alert("提示",errMsg);
                    }
                });
            });
        };
        
        /**
         * 新增接入平台
         */
        $scope.addPlatform = function(){
        	$scope.$setParam("clickId",'');
        	$scope.$setParam("remark","add");
        	$scope.$openDialog("addDialog",{
        		title : "新增接入平台",
                width : 640,
                height : 560,
                href : "tpls/deviceManage/accessPlatform/access-platform-operate.html"
        	});
        	/**
             * 新增保存
             */
            $scope.$setParam("saveData",function(data) {
                //后台保存数据
                $scope.$ajaxRequest({
                    url: $scope.$restRoot+"device/monitorPlatformManage/addPlatform",
                    params: data,
                    method: "post",
                    success: function(data){
                        $scope.$getDialog("addDialog").dialog("close");
                        $scope.$ajaxRequest({
				            url:$scope.$restRoot+"device/monitorPlatformManage/queryMonitorAndPlatform",
				            params:{},
				            method:"post",
				            success:function(data){
				                $scope.$("#serverPlatId").combotree("loadData",data);
				            },
				            fail:function(errMsg){
				                $.messager.alert("提示","初始化接入平台失败！");
				            }
				        });
                    },
                    fail: function(errMsg){
                        $.messager.alert("提示","添加失败！");
                    }
                });
            });
        };
        //添加点位
		$scope.addSite = function(){
			$scope.$openDialog("addDialog", {
                title : "新增点位",
                height : 600,
                width : 800,
                href : 'tpls/sysManagement/roadNetworkMessage/point-segment-add.html'
            });
            //保存点位信息
            $scope.$setParam("saveData", function(data) {
                $scope.$ajaxRequest({
                    url : $scope.$restRoot + "device/site/addSite",
                    params : {jsonSitelString:JSON.stringify(data)},
                    success : function(data) {
                        //关闭窗口
                        $scope.$getDialog("addDialog").dialog("close");
                        $.messager.alert("提示","添加点位相关信息成功！");
                        var roadId = $scope.$("#roadId").textbox("getValue");
						var orgId = $scope.$("#orgId").textbox("getValue");
						if(roadId != "" || orgId != ""){
							var datas = {};//存机构或道路
							datas.roadId = roadId;
							datas.orgId = orgId;
							$scope.$ajaxRequest({
				        		url: $scope.$restRoot+'device/site/querySites',
				        		params: datas,
				        		success: function(data){
				        			if(data!= undefined){//如果返回数据，加载数据，并清空之前选择的点位	        				
					        			$scope.$("#siteId").combobox("loadData",data);
				            		}
			                    },
			                });
			             }
                    },
                    fail : function(errMsg){
	                	$.messager.alert("提示","添加点位相关信息失败！");
	                }
                });
            });
		};
        //查询关联设备信息加载
        function queryDeviceInfo(orgId){
        	var privCode = $scope.$getOrgPrivCode(orgId);//根据机构ID查机构过滤代码
        	$scope.$ajaxRequest({
                url:$scope.$restRoot+"device/deviceConfig/queryRelevanceDevice",
                params:{orgPrivilegeCode : privCode},
                method:"post",
                success:function(data){
	            	if(data != undefined){
	            		if(data["03"]){
	            			$scope.$("#sp").combobox("loadData",data["03"]);//视频设备
	            		}
	            		else{//
	            			LoadCombobox("#sp",data);//清空原来加载的视频设备
	            		}
	            	   	if(data["06"]){
	            	   		$scope.$("#xsp").combobox("loadData",data["06"]);//限速牌
	            	   	}	            	   	
	            	   	else{
	            			LoadCombobox("#xsp",data);//清空原来加载的限速牌设备
	            		}
	            	   	if(data["07"]){
		               		$scope.$("#ydp").combobox("loadData",data["07"]);//诱导屏
		               	}
		               	else{
	            			LoadCombobox("#ydp",data);//清空原来加载的诱导屏
	            		}
		               	if(data["04"]){
		               		$scope.$("#cs").combobox("loadData",data["04"]);//测速设备
		               	}
		               	else{
	            			LoadCombobox("#cs",data);//清空原来加载的测速设备
	            		}
	            	}
                },
                fail:function(errMsg){
                    $.messager.alert("提示","初始关联设备失败，请重新打开此页面！");
                }
            });
        } 
		
		//根据点位ID查询断面的方向
        $scope.$('#siteId').combobox({
		    onChange:function(newValue,oldValue){
		    	//根据点位生成设备名称
				if($scope.remark == 'ADD'){
					var deviceName = $scope.$('#siteId').combobox('getText');
					$scope.$('#deviceName').textbox('setValue',deviceName + $scope.$getCodeName("400","05"));
				}
		    	$scope.$("#derictionName").textbox("setValue","");//清空方向名称值
		    	$scope.$("#derictionName").combobox("loadData",[]);
		    	var siteId = $scope.$("#siteId").textbox("getValue");
		    	if(!siteId || siteId != ''){
		    		$scope.$ajaxRequest({
		        		url: $scope.$restRoot+'device/deviceConfig/querySectionBySiteId',
		        		params: {siteId:siteId},
		        		success: function(data){
		        			$scope.$("#derictionName").combobox("loadData",data);
		        		},
		        		fail: function(errMsg){
		        			$.messager.alert("提示","方向加载失败！");
		        		}	
		        	});	
		    	}
		    }
		});
		//清空方向名称值
		$scope.$('#derictionName').combobox({
			onChange:function(newValue,oldValue){
		    	var value=$scope.$("#derictionName").textbox("getText");
		    	while(value.startWith(",")){
		    		value=value.substring(1,value.length);
		    	}
		    	$scope.$("#derictionName").textbox("setText",value);
		   },
		   //成功加载时,再次清空
		   onLoadSuccess : function(){
		    	var value=$scope.$("#derictionName").textbox("getText");
		    	while(value.startWith(",")){
		    		value=value.substring(1,value.length);
		    	}
		    	$scope.$("#derictionName").textbox("setText",value);
		   }
		 });
		//根据机构加载点位或加载相关设备
		$scope.getSiteAndDeviceByOrg = function(newValue,oldValue){
			//根据所选机构自动生成设备编号
			if ($scope.remark == 'ADD') {
				if(newValue == ""){
					$scope.$('#deviceSysNbr').textbox('setValue',null);
				}else{
					var orgId = $scope.$('#orgId').textbox('getValue');
					//根据机构ID获取机构编码
					$scope.$ajaxRequest({
						url : $scope.$restRoot + 'sysCfg/org/queryOrgInfoById',
						params : {orgId : orgId},
						method : 'post',
						success : function(org) {
							//查询该机构下该类型的设备有多少
							$scope.$ajaxRequest({
								url : $scope.$restRoot + 'device/deviceConfig/queryDeviceByOrgId',
								params : {orgId : orgId, deviceType : "05"},
								method : 'post',
								success : function(data) {
									var code = "";//存储设备编号后四位
									if(data != ""){
										var deviceSysNbr = data.split(",");//该机构下所有卡口设备的后四位设备编号数组
										var deviceSysNbrMax = parseInt(deviceSysNbr[deviceSysNbr.length]);
										if(deviceSysNbrMax + 1 <= 9999){
											if(deviceSysNbrMax >= 0 && deviceSysNbrMax < 9){
												code = "000" + (deviceSysNbrMax + 1).toString();
											}else if(deviceSysNbrMax >= 9 && deviceSysNbrMax < 99){
												code = "00" + (deviceSysNbrMax + 1).toString();
											}else if(deviceSysNbrMax >= 99 && deviceSysNbrMax < 999){
												code = "0" + (deviceSysNbrMax + 1).toString();
											}else if(deviceSysNbrMax >= 999 && deviceSysNbrMax < 9999){
												code = (deviceSysNbrMax + 1).toString();
											}
										}else{
											while(true){
												code = parseInt(Math.random()*9999+1).toString();//取0到9999之前的随机整数 
												if(deviceSysNbr.indexOf(code) == -1){
													break;
												}
											}
											if(parseInt(code) >= 0 && parseInt(code) < 9){
												code = "000" + code;
											}else if(parseInt(code) >= 9 && parseInt(code) < 99){
												code = "00" + code;
											}else if(parseInt(code) >= 99 && parseInt(code) < 999){
												code = "0" + code;
											}
										}
									}else{
										code = "0000";
									}
									var orgCode = org.orgCode + "05" + code;
									$scope.$('#deviceSysNbr').textbox('setValue',orgCode);
								}
							});
						}
					});
				}
			}
			$scope.$("#roadId").textbox("clear");//清空原来加载的道路
			$scope.$("#siteId").combobox("clear");//清空原来加载的点位
			$scope.$("#sp").combobox("clear");//清空原来加载的视频设备
			$scope.$("#xsp").combobox("clear");//清空原来加载的限速牌设备
			$scope.$("#ydp").combobox("clear");//清空原来加载的诱导屏
			$scope.$("#cs").combobox("clear");//清空原来加载的测速设备
			var roadId = $scope.$("#roadId").textbox("getValue");
			var orgId = $scope.$("#orgId").textbox("getValue");
			if(roadId != "" || orgId != ""){
				var datas = {};//存机构或道路
				datas.roadId = roadId;
				datas.orgId = orgId;
				$scope.$ajaxRequest({
	        		url: $scope.$restRoot+'device/site/querySites',
	        		params: datas,
	        		success: function(data){
	        			if(data!= undefined){//如果返回数据，加载数据，并清空之前选择的点位
		        			$scope.$("#siteId").combobox("loadData",data);
	            		}else{
							$scope.$("#siteId").combobox("loadData",[]);//加载点位为空
    					}
	        			if(orgId != ""){
	        				queryDeviceInfo(orgId);//加载相关设备
	        			}else{
	        				$scope.$("#sp").combobox("loadData",[]);//视频设备
	               	   		$scope.$("#xsp").combobox("loadData",[]);//限速牌
	                   		$scope.$("#ydp").combobox("loadData",[]);//诱导屏
	                   		$scope.$("#cs").combobox("loadData",[]);//测速设备
	        			}
	        		},
	        		fail: function(errMsg){
	        			$.messager.alert("提示","点位加载失败！");
	        		}	
	        	});	
			}else{
				$scope.$("#siteId").combobox("loadData",[]);
       			$scope.$("#sp").combobox("loadData",[]);//视频设备
       	   		$scope.$("#xsp").combobox("loadData",[]);//限速牌
           		$scope.$("#ydp").combobox("loadData",[]);//诱导屏
           		$scope.$("#cs").combobox("loadData",[]);//测速设备
			}
		};
		/**
		 *联动
		 */
		//机构和道路的联动
		$scope.getRoadByOrg = function(id,text,attribute){
			var orgId = $scope.$("#orgId").textbox("getValue");
			var privCode = $scope.$getOrgPrivCode(orgId);
			if(!orgId || orgId == ''){
				return true;
			}
			if(attribute.nodeType == "road"){
				var orgPrivCodes = attribute.orgPrivCode.split(",");
				for(var i in orgPrivCodes){
					if(orgPrivCodes[i].startWith(privCode)){
						return true;
					}
				}
				return false;
			}else{
				return true;
			}
		};

		//根据是否支持气象来确定其他两项勾选取消
        $scope.isWeatherSupportChecked = function(){
        	if($scope.$("#isWeatherSupport").is(":checked")){
				$scope.$("#isWeatherSupport").val(1);
				var ck = $(":checkbox[name !=isWeatherSupport]");
				var currSelect = $("input[name = isWeatherSupport]").is(':checked');
				$.each(ck, function(i) {
					ck[i].checked = !currSelect;
				});
        	}
		};
       //根据是否支持路感来确定其他两项勾选取消
        $scope.isRoadsensorSupportChecked = function(){
        	if($scope.$("#isRoadsensorSupport").is(":checked")){
				$scope.$("#isRoadsensorSupport").val(1);
				var ck = $(":checkbox[name !=isRoadsensorSupport]");
				var currSelect = $("input[name = isRoadsensorSupport]").is(':checked');
				$.each(ck, function(i) {
					ck[i].checked = !currSelect;
				});
        	}
		};
       //根据是否支持气象仪来确定其他两项勾选取消
        $scope.isVisibilitySupportChecked = function(){
        	if($scope.$("#isVisibilitySupport").is(":checked")){
				$scope.$("#isVisibilitySupport").val(1);
				var ck = $(":checkbox[name !=isVisibilitySupport]");
				var currSelect = $("input[name = isVisibilitySupport]").is(':checked');
				$.each(ck, function(i) {
					ck[i].checked = !currSelect;
				});
        	}
		};
	});
</script>
<style type="text/css">
	#meteorologicalOperate .th{
        width: 90px;
        text-align: right;
    }
    #meteorologicalOperate .td>input[class^='easyui-']{
        width: 174px;
    }
    #meteorologicalOperate .panel_title{
        position: relative;
        width: 60px;
    }
    #meteorologicalOperate .selectedLane{
        background:orange;
    }
	#meteorologicalOperate .containerDown{
        display:-moz-box;
        display:-webkit-box;
        display:box;
        width: 100%;
        -moz-box-align:center;
        -webkit-box-align:center;
        box-align:center;
        -moz-box-pack:center;
        -webkit-box-pack:center;
        box-pack:center;
        background: rgba(94, 94, 121, 0.93);
    }
    #meteorologicalOperate .leftDown{
        width: 150px;
        text-align: center;
        vertical-align: middle;
        height: 100%;
        font-size: 18px;
        color: #ffffff;
    }
    #meteorologicalOperate .centerDown{
        -moz-box-flex:1;
        -webkit-box-flex:1;
        box-flex:1;
    }
    #meteorologicalOperate .centerDown div{
        border-bottom: dashed #ffffff 2px;
        height: 30px;
        color: #ffffff;
    }
    #meteorologicalOperate .rightDown{
        width: 150px;
        height: 100%;
        text-align: center;
        vertical-align: middle;
        font-size: 18px;
        color: #ffffff;
    }
    #meteorologicalOperate .centerDown div:nth-last-child(1){
        border-bottom: 0px
    }
</style>