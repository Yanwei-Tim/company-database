<div id="bulkUpload" class="easyui-layout"><div data-options="region:'north',border:false,height:37" style="border-bottom:solid 1px #ddd"><div class="linkbutton_toolbar"><a id="chooseFile" class="easyui-linkbutton button-search" data-options="iconCls:'icon-search'">选择文件</a> <a class="easyui-linkbutton button-remove" data-options="iconCls:'icon-remove'" cy-click="removeData">删除</a> <a class="easyui-linkbutton button-edit" data-options="iconCls:'icon-edit'" cy-click="showAdjustArea">批量校正</a> <a class="easyui-linkbutton button" data-options="iconCls:'icon-import'">全部导入</a></div><form><div class="searchPanel" style="display:none;width:750px" id="adjustDiv"><div class="panel_title">批量校正</div><div class="table"><div class="tr"><div class="th">违法道路：</div><div class="td"><input class="easyui-combotree" style="width:120px"></div><div class="th">路口路段：</div><div class="td"><input class="easyui-combobox" style="width:120px"></div><div class="th" style="width:50px">米数：</div><div class="td" style="width:80px"><input class="easyui-numberbox" style="width:80px"></div><div class="th" style="width:90px">采集设备：</div><div class="td"><input class="easyui-combobox" style="width:120px"></div></div><div class="tr"><div class="th">地点描述：</div><div class="td"><input class="easyui-textbox" style="width:650px"></div></div><div class="tr"><div class="th">采集方式：</div><div class="td"><input class="easyui-combobox" style="width:120px"></div><div class="th">采集机构：</div><div class="td"><input class="easyui-combotree" style="width:120px"></div><div class="th">行政区划：</div><div class="td"><input class="easyui-combotree" style="width:120px"></div><div class="th" style="width:150px"><a class="easyui-linkbutton button-save" data-options="iconCls:'icon-save'">校正</a> <a cy-click="showAdjustArea" class="easyui-linkbutton button" data-options="iconCls:'icon-up'">收起</a></div></div></div></div><form></form></form></div><div data-options="region:'center',border:false" style="border-right:solid 1px #ddd"><table id="datagrid" cy-datagrid="options"></table></div><div id="viewImageArea" data-options="href:'tpls/passvehicle/track_query/imageView.html',
			region:'east',border:false,width:450"></div></div><script type="text/javascript">InitPage([],function(e){function t(t){var i=new FileReader;i.readAsText(t.getSource().getSource(),e.importTemplate.encoding),i.onload=function(i){var a=$(this.result).eq(1).children(),n={};a.each(function(){n[this.tagName.toLowerCase()]=$(this).text()});var r=o(n,t.name);e.$("#datagrid").datagrid("appendRow",r),e.$("#datagrid").datagrid("getSelected")||e.$("#datagrid").datagrid("selectRow",0)}}function i(t){var i=t.name.substring(0,t.name.lastIndexOf("_"));e.imageFiles[i]||(e.imageFiles[i]=[],e.imageUrls[i]=[]),e.imageFiles[i].push(t);var a=new FileReader;a.readAsDataURL(t.getSource().getSource()),a.onload=function(t){e.imageUrls[i].push(this.result)}}function a(){return new plupload.Uploader({runtimes:"html5",browse_button:"chooseFile",container:e.$(".linkbutton_toolbar")[0],url:"upload.php",filters:{max_file_size:"10mb",mime_types:[{title:"违法数据文件",extensions:"dat"},{title:"照片文件",extensions:"jpg,png"}]},init:{PostInit:function(){},FilesAdded:function(e,a){n(a);for(var r=0;r<a.length;r++){var l=a[r];l.name.endWith("dat")?(t(l),a.splice(r--,1)):l.name.endWith("jpg")&&i(l)}},Error:function(e,t){console.log(t)}}})}function n(e){for(var t=0;t<e.length;t++){var i=e[t];if(i.name.endWith("dat")){var a=i.name.substring(0,i.name.lastIndexOf("."));r(a)&&e.splice(t--,1)}else if(i.name.endWith("jpg")){var a=i.name.substring(0,i.name.lastIndexOf("_"));l(a)&&e.splice(t--,1)}}}function r(t){for(var i=e.$("#datagrid").datagrid("getData").rows,a=0;a<i.length;a++)if(i[a].fileName==t)return!0;return!1}function l(t){return void 0!=e.imageFiles[t]?!0:!1}function o(t,i){var a={};$.extend(a,e.importTemplate);for(var n in a)void 0!=t[a[n]]&&""!=t[a[n]]&&(a[n]=t[a[n]]);return a.fileName=i.substring(0,i.lastIndexOf(".")),a}function d(e,t,i){return"H"==t.plateColor?"<div class='plate_blue'>&nbsp;&nbsp;"+e+"</div>":"C"==t.plateColor?"<div class='plate_yellow'>&nbsp;&nbsp;"+e+"</div>":e}var s,u=[];e.options={columns:[[{field:"id",checkbox:!0},{title:"号牌号码",field:"plateNbr",width:100,formatter:d},{title:"违法时间",field:"violationTime",width:160},{title:"速度",field:"speed",width:70},{title:"违法行为",field:"violationDesc",width:120},{title:"地点描述",field:"violationAddressDesc",width:150},{title:"违法道路",field:"roadCode",width:100},{title:"路口路段",field:"junctionCode",width:100},{title:"设备编号",field:"deviceNbr",width:100},{title:"行政区划",field:"districtCode",width:100},{title:"操作",field:"operate",width:100}]],pagination:!1,onSelect:function(t,i){if(s!=i){var a=e.imageUrls[i.fileName];e.$setParam("images",a),e.$("#viewImageArea").panel("refresh","tpls/passvehicle/track_query/imageView.html"),s=i}},onCheck:function(e,t){u.push(e)},onUncheck:function(e,t){for(var i in u)if(u[i]==e){u.splice(e,1);break}},onCheckAll:function(e){u=[];for(var t=0;t<e.length;t++)u.push(t)},onUncheckAll:function(e){u=[]}};var c=!1;e.showAdjustArea=function(){c?(e.$("#adjustDiv").hide(),e.$("#bulkUpload").layout("panel","north").panel("resize",{height:37}),e.$("#bulkUpload").layout("resize"),c=!1):(e.$("#adjustDiv").slideDown("fast"),e.$("#bulkUpload").layout("panel","north").panel("resize",{height:180}),e.$("#bulkUpload").layout("resize"),c=!0)},e.load=function(){e.uploader=a(),e.importTemplate={},e.imageFiles={},e.imageUrls={},$.ajax({url:"config/VioImportTemplate.xml",dataType:"xml",success:function(t){var t=$(t).find("appConfig").children();t.each(function(){e.importTemplate[$(this).attr("name")]=$(this).text()}),e.uploader.init()},error:function(){$.messager.alert("警告","读取违法文件配置模板失败！")}})},e.removeData=function(){var t=e.$("#datagrid").datagrid("getChecked");return 0==t.length?void $.messager.alert("警告","请选择要删除的数据！"):void $.messager.confirm("确认","确定删除这些数据？",function(i){if(i){for(var a=0;a<t.length;a++){var n=t[a].fileName;delete e.imageFiles[n],delete e.imageUrls[n]}u.sort(function(e,t){return t-e});for(var a in u)e.$("#datagrid").datagrid("deleteRow",u[a]);u=[],void 0!=!e.$("#datagrid").datagrid("getSelected")&&e.$("#datagrid").datagrid("getSelected")||e.$("#viewImageArea").panel("refresh","tpls/passvehicle/track_query/imageView.html")}})}});</script><style type="text/css">#bulkUpload .plate_yellow{background-color:#ff0;width:100%;height:100%}#bulkUpload .plate_blue{background-color:#00f;color:#FFF;width:100%;height:100%}#bulkUpload .th{width:70px;text-align:right}#bulkUpload .td{width:120px;text-align:left}</style>