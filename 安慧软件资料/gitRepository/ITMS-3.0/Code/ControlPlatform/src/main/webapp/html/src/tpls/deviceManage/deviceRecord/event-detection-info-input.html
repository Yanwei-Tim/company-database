<div id="deviceSysInfo" class="easyui-layout" style="overflow:auto;">
	<div data-options="region:'north',height:45,border:false">
		<!--保存按钮-->
		<div style="margin: 8px;">
			<a class="easyui-linkbutton button-right button-save button-main" data-options="iconCls:'icon-right'" cy-click="saveAndNext">保存并下一步</a>
			<a class="easyui-linkbutton button-save button-main" data-options="iconCls:'icon-save'"  cy-click="saveOnly">保存</a>
			<a class="easyui-linkbutton" data-options="iconCls:'icon-cancel'" cy-click="destroyTab1">关闭</a>
		</div>
	</div>
	<div  data-options="region:'center',border:false">
		<form cy-form="formData" id="form">
			<div class="searchPanel">
				<div class="panel_title">
					基本信息
				</div>
				<div id="eventBase" class="table">
					<div class="tr">
						<div class="th">
							设备编号：
						</div>
						<div class="td">
							<input type="hidden" id="deviceType" name="deviceType"/>
							<input type="hidden" id="deviceTypeName" name="deviceTypeName"/>
							<input class="easyui-textbox" id="deviceSysNbr" name="deviceSysNbr" data-options="prompt:'选择机构后可自动生成',validType:['fixedLength[18]','numOrLetter'],required:true"/>
						</div>
						<div class="th">
							设备名称：
						</div>
						<div class="td">
							<input class="easyui-textbox" id="deviceName" name="deviceName" data-options="prompt:'选择点位后可自动生成',validType:['length[0,128]','blank'],required:true"/>
						</div>
						<div class="th">
							所属机构：
						</div>
						<div class="td">
							<input id="orgId" class="cy-org-radio" after-change="getSiteByOrg" name="orgId"   data-options="required:true"/>
						</div>
					</div>
					<div class="tr">
						<div class="th">
							所属道路：
						</div>
						<div class="td">
							<input id="roadId" class="cy-road-radio" after-change="getSiteByRoad" name="roadId" filter="getRoadByOrg"/>
						</div>
						<div class="th">
							所在点位：
						</div>
						<div class="td">
							<input id="siteId" class="easyui-combobox" name="siteId"  style="width: 154px;"	data-options="valueField:'siteId',textField:'siteName',required:true"/>
							<a class="easyui-linkbutton button-add" data-options="iconCls:'icon-add-solid',plain:true,selected:true" cy-click="addSite"></a>
						</div>
						<div class="th">
							方向名称：
						</div>
						<div class="td">
							<input class="easyui-combobox" id="derictionName" name="sectionIdList" data-options="valueField:'id',textField:'text',multiple:true"/>
						</div>

					</div>
					<div class="tr">
						<div class="th">
							所属合同：
						</div>
						<div class="td">
							<input class="easyui-combobox" id="contract" name="contractId" data-options="valueField:'id',textField:'text'" style="width: 154px;"/>
							<a class="easyui-linkbutton button-add" data-options="iconCls:'icon-add-solid',plain:true,selected:true" cy-click="addContract"></a>
						</div>
						<div class="th">
							厂 &nbsp;&nbsp;商：
						</div>
						<div class="td">
							<input id="contractorId" class="easyui-combobox" name="contractorId" style="width: 154px;" data-options="valueField:'contractorId',textField:'contractorName',required:true" />
							<a class="easyui-linkbutton button-add" data-options="iconCls:'icon-add-solid',plain:true,selected:true" cy-click="addCompany"></a>
						</div>
						<div class="th">
							建设归属：
						</div>
						<div class="td">
							<input type="radio"  name="ownership" value="1" checked="true" style="width: auto" />
							交警
							<input type="radio" name="ownership" value="2" style="width: auto" />
							公安
							<input type="radio" name="ownership" value="3" style="width: auto" />
							其它
						</div>
					</div>
					<div class="tr">
						<div class="th">
							设备品牌：
						</div>
						<div class="td">
							<input class="easyui-textbox" name="deviceBrand" data-options="validType:'length[0,16]'"/>
						</div>
						<div class="th">
							安装人：
						</div>
						<div class="td">
							<input class="easyui-textbox" name="installBy" data-options="validType:'length[0,16]'"/>
						</div>
						<div class="th">
							安装日期：
						</div>
						<div class="td">
							<input class="easyui-datebox" name="installDate"  validType="date"/>
						</div>
					</div>
					<div class="tr">
						<div class="th">
							安装方式：
						</div>
						<div class="td" style="width: 315px;">
							<input type="radio" name="mountingFacilityType" style="width: auto" value="1" checked="true"/>
							L杆
							<input type="radio" name="mountingFacilityType" style="width: auto" value="2"/>
							M型龙门架
							<input type="radio" name="mountingFacilityType" style="width: auto"  value="3"/>
							N型龙门架
							<input type="radio" name="mountingFacilityType" style="width: auto" value="4"/>
							F杆
							<input type="radio" name="mountingFacilityType" style="width: auto"  value="5"/>
							其它
						</div>
						<div class="th" style="width: 90px;">
							备注：
						</div>
						<div class="td" >
							<input class="easyui-textbox" data-options="validType:'length[0,16]',multiline:true" name="remark" style="width: 322px; height:40px;"/>
						</div>
					</div>
				</div>
			</div>
			<div class="searchPanel">
				<div class="panel_title">
					联网与接入
				</div>
				<div id="eventNetwork" class="table">
					<div class="tr">
						<div class="th">
							联网类型：
						</div>
						<div class="td">
							<input type="radio" name="networkType" value="1" checked/>
							公安网
							<input type="radio" name="networkType" value="2"/>
							专网
							<input type="radio" name="networkType" value="3"/>
							互联网
							<input type="radio" name="networkType" value="4"/>
							未联网

						</div>
						<div class="th">
							供电类型：
						</div>
						<div class="td">
							<input type="radio" name="powerType"  value="1" checked="true"/>
							农电
							<input type="radio" name="powerType"  value="2"/>
							市电
							<input type="radio" name="powerType"  value="3"/>
							太阳能

						</div>
						<div class="th">
							传入方式：
						</div>
						<div class="td">
							<input type="radio"  name="transmissionMode" value="1" checked="true"/>
							专线
							<input type="radio"  name="transmissionMode" value="2"/>
							3G
							<input type="radio"  name="transmissionMode" value="3"/>
							4G <div></div>
						</div>
					</div>
					<div class="tr">
						<div class="th">
							接入方式：
						</div>
						<div class="td">
							<input type="radio" name="safeConnectMeans" value="1" checked="true"/>
							公安网
							<input type="radio" name="safeConnectMeans" value="2"/>
							专网
							<input type="radio" name="safeConnectMeans" value="3"/>
							互联网
							<input type="radio" name="safeConnectMeans" value="4"/>
							未联网
						</div>
						<div class="th">
							网络带宽：
						</div>
						<div class="td">
							<input class="easyui-textbox" name="bandwidth" style="width: 168px;" validType = 'length[0,32]'/>
						</div>
						<div class="th">
							接入平台：
						</div>
						<div class="td">
							 <input  id="serverPlatId" name="serverPlatId" data-options="valueField:'id',textField:'text'" style="width:150px"/>
                        	<a class="easyui-linkbutton button-add" data-options="iconCls:'icon-add-solid',plain:true,selected:true" cy-click="addPlatform"></a>
						</div>
					</div>
					<div id="eventDevice" class="tr">
						<div class="th">
							设备IP：
						</div>
						<div class="td">
							<input class="easyui-textbox" name="deviceIp" validType='ip'/>
						</div>
						<div class="th">
							端口号：
						</div>
						<div class="td">
							<input class="easyui-textbox" name="devicePort" data-options="validType:['length[0,20]','number']"/>
						</div>
						<div class="th">
							出厂序列号：
						</div>
						<div class="td">
							<input class="easyui-textbox" name="manufactureSn" data-options="validType:'length[0,32]'"/>
						</div>
					</div>
					<div id="eventDeviceTr" class="tr">
						<div class="th">
							软件版本：
						</div>
						<div class="td">
							<input class="easyui-textbox" name="softwareVersion" data-options="validType:'length[0,16]'"/>
						</div>
						<div class="th">
							SIM卡号：
						</div>
						<div class="td">
							<input class="easyui-textbox" name="simNbr" data-options="validType:['length[0,32]','number']"/>
						</div>
						<div class="th">
							用户名：
						</div>
						<div class="td">
							<input class="easyui-textbox" name="userName" data-options="validType:'length[0,16]'"/>
						</div>
					</div>
					<div class="tr">
						<div class="th">
							密码：
						</div>
						<div class="td">
							<input class="easyui-textbox" name="password" type="password"/>
						</div>
					</div>
				</div>
			</div>
			<div class="searchPanel">
				<div class="panel_title">
					功能与参数
				</div>
				<div id="eventDeviceFunction" class="table">
					
				<div class="tr">
					<div class="th">事件种类：</div>
					<div class="td">
						<input type="hidden" id="eventDetectionListStr" name="eventDetectionListStr">
						<input id="eventDetectionListId" type="checkbox"  value=""/>全选
						<input type="checkbox" name="eventDetectionList" cy-click="cancelAllCheck" value="0"/>拥堵
						<input type="checkbox" name="eventDetectionList" cy-click="cancelAllCheck" value="1"/>停车
						<input type="checkbox" name="eventDetectionList" cy-click="cancelAllCheck" value="2"/>逆行
						<input type="checkbox" name="eventDetectionList" cy-click="cancelAllCheck" value="3"/>行人
						<input type="checkbox" name="eventDetectionList"  cy-click="cancelAllCheck" value="4"/>遗留物，抛洒物碎片
						</div>
					</div>
				<div class="tr">
					<div class="th" style="width: 158px;"></div>
					<div class="td">
						<input type="checkbox" name="eventDetectionList" cy-click="cancelAllCheck" value="5"/>烟雾
						<input type="checkbox" name="eventDetectionList" cy-click="cancelAllCheck" value="6"/>压线
						<input type="checkbox" name="eventDetectionList" cy-click="cancelAllCheck" value="7"/>黑名单数据
						<input type="checkbox" name="eventDetectionList" cy-click="cancelAllCheck" value="8"/>超速
						<input type="checkbox" name="eventDetectionList" cy-click="cancelAllCheck" value="9"/>变道
						<input type="checkbox" name="eventDetectionList" cy-click="cancelAllCheck" value="10"/>掉头
					</div>
				</div>
				</div>
			</div>
			
		</form>
	</div>
</div>
<script>
	InitPage(["destroyTab1","deviceType","deviceSysConfigTabs","deviceId","deviceInfoDto","saveData","remark","certificationUnregistered"], function($scope) {
		var oldDeviceSysNbr = "";
    	var eventDetectionListStr= "";
       	$scope.load = function(){
       		//编辑设备时对不同状态的设备不予编辑的选项
			if($scope.deviceInfoDto){
				if($scope.deviceInfoDto.useStatusFlag == 1 || $scope.deviceInfoDto.useStatusFlag == 2  || $scope.deviceInfoDto.useStatusFlag == 3){//启用，停用，报废的设备
					$scope.$("#orgId").textbox("disable");
					$scope.$("#roadId").textbox("disable");
					$scope.$("#siteId").combobox("disable");
					$scope.$("#derictionName").combobox("disable");
				}
			}
            var deviceInfoDto = $scope.deviceInfoDto;
            oldDeviceSysNbr = deviceInfoDto.deviceSysNbr;
            if($scope.deviceInfoDto.eventDetectionListStr){
            	// var checkboxArray = ["0,1,2,3,4,5,6,7,8,9,10,"];
            	eventDetectionListStr= $scope.deviceInfoDto.eventDetectionListStr;
            	var eventDetectionList=eventDetectionListStr.split(",");
            	var value="";
            	// var checkboxValue=[];
            	for(var i=0;i<eventDetectionList.length;i++){
            		value=eventDetectionList[i];
            		$scope.$("input[name='eventDetectionList']").each(function() {  
						if(value==$(this).val()){
            				$(this).prop("checked", true); 
            			}
            			// if (checkboxValue.push(value+",")== checkboxArray) {
							// $scope.$("#eventDetectionListId").prop("checked", true);
						// }
            		});  
            	
            	}	
            }
            if ($scope.certificationUnregistered == "certificationUnregistered") {
            	$scope.$("#deviceSysNbr").textbox("readonly",true);
            }
            //查询合同信息加载
            queryContract();
            var remark = $scope.remark;
            var deviceType = $scope.deviceType;
            var devName = $scope.$getCodeName("400",deviceType);
            $scope.$("#deviceType").val(deviceType);
            $scope.$("#deviceTypeName").val(devName);
            //删除对象字段值为null的字段
            for(var key in deviceInfoDto){
            	if(deviceInfoDto[key] == null){
            		delete deviceInfoDto[key];
            	}
            }
            $scope.formData = deviceInfoDto ? deviceInfoDto : {} ;
            $scope.$updateDom("formData");  //将formData中的数据加载到页面
            $scope.$("#siteId").textbox('setText',deviceInfoDto.siteName);
            //根据道路加载点位
			$scope.getSiteByRoad = function(){
				$scope.$("#siteId").combobox("clear");
				var roadId = $scope.$("#roadId").textbox("getValue"); 
				var orgId = $scope.$("#orgId").textbox("getValue");
				var datas = {};//存机构或道路
				datas.roadId = roadId;
				datas.orgId = orgId;
				$scope.$ajaxRequest({
    				url: $scope.$restRoot+'device/site/querySites',
    				params: datas,
    				success: function(data){
    					if(data.length != 0){
    						$scope.$("#siteId").combobox("loadData",data);
    					}else{
							$scope.$("#siteId").combobox("loadData",[]);//加载点位为空
    					}
    				},
    				fail: function(errMsg){
    					$.messager.alert("提示","点位加载失败！");
    				}	
    			});	
			};
        };
       
		//全部选中         
        $scope.$("#eventDetectionListId").click(function(){
        	var flag = $(this).prop("checked");
        	if (flag) {  
        		var checkboxValue="";
            	$scope.$("input[name='eventDetectionList']").each(function() {  
                	$(this).prop("checked", true); 
                   	checkboxValue +=$(this).val()+",";
				});  
            	$scope.$("#eventDetectionListStr").val(checkboxValue);
           	} else {  
        		$("input[name='eventDetectionList']").each(function() {  
                	$(this).prop("checked", false);  
            	}); 
            	$scope.$("#eventDetectionListStr").val(checkboxValue);
        	}  
        });
   		//取消全部选中
		$scope.cancelAllCheck = function() {
			var checkboxArray = "0,1,2,3,4,5,6,7,8,9,10,";
			var flag = $(this).prop("checked");
			var checkboxValue="";
			if (!flag) {
				if ($scope.$('#eventDetectionListId').prop("checked", false)) {
					$scope.$("input[name='eventDetectionList']:checked").each(function() {
						checkboxValue +=$(this).val()+",";
					});
				}
				
			} else {
				$scope.$("input[name='eventDetectionList']:checked").each(function() {
						 checkboxValue +=$(this).val()+",";
							if (checkboxValue == checkboxArray) {
								$scope.$("#eventDetectionListId").prop("checked", true);
							}
				});
				
			}
			$scope.$("#eventDetectionListStr").val(checkboxValue);
		};
        //查询合同信息加载
        function queryContract(){
        	$scope.$ajaxRequest({
                url:$scope.$restRoot+"device/contractManage/queryAllContract",
                params:{},
                method:"post",
                success:function(data){
                    $scope.$("#contract").combobox("loadData",data);
                    queryContractor();
                },
                fail:function(errMsg){
                    $.messager.alert("提示","初始化合同失败，请重新打开此页面！");
                }
            });
        }
        //查询厂商信息加载
        function queryContractor(){
        	$scope.$ajaxRequest({
                url:$scope.$restRoot+"device/companyManage/queryCompany",
                params:{},
                method:"post",
                success:function(data){
                    $scope.$("#contractorId").combobox("loadData",data);
                     queryAccessPlatform();
                },
                fail:function(errMsg){
                    $.messager.alert("提示","初始化厂商失败，请重新打开此页面！");
                }
            });
        }
        //查询接入平台加载
        function queryAccessPlatform(){
        	$scope.$ajaxRequest({
                url:$scope.$restRoot+"device/monitorPlatformManage/queryMonitorAndPlatform",
                params:{},
                method:"post",
                success:function(data){
                     //判断是否选择的是接入平台
					$scope.$('#serverPlatId').combotree({
						data : data,
						onSelect : function(node) {
						var isLeaf = $scope.$('#serverPlatId').combotree('tree').tree('isLeaf',node.target);// 获取树对象
						//获取选中的节点判断是否是叶子节点
                            if (!isLeaf) {
                               	$.messager.alert("提示","请选择接入平台！");
								$scope.$('#serverPlatId').combotree('clear');//清除combotree组件中的值
								return false;
                            }
                        }		
					});
                },
                fail:function(errMsg){
                    $.messager.alert("提示","初始化接入平台失败，请重新打开此页面！");
                }
            });
        }
       
        /**
		 * 新增接入平台
		 */
		$scope.addPlatform = function() {
			$scope.$setParam("clickId", '');
			$scope.$setParam("remark", "add");
			$scope.$openDialog("addDialog", {
				title : "新增接入平台",
				width : 640,
				height : 560,
				href : "tpls/deviceManage/accessPlatform/access-platform-operate.html"
			});
        	/**
			 * 新增保存
			 */
			$scope.$setParam("saveData", function(data) {
				//后台保存数据
				$scope.$ajaxRequest({
					url : $scope.$restRoot + "device/monitorPlatformManage/addPlatform",
					params : data,
					method : "post",
					success : function(data) {
						$scope.$getDialog("addDialog").dialog("close");
						$scope.$ajaxRequest({
							url : $scope.$restRoot + "device/monitorPlatformManage/queryMonitorAndPlatform",
							params : {},
							method : "post",
							success : function(data) {
								$scope.$("#serverPlatId").combobox("loadData", data);
							},
							fail : function(errMsg) {
								$.messager.alert("提示", "初始化接入平台失败！");
							}
						});
					},
					fail : function(errMsg) {
						$.messager.alert("提示", "添加失败！");
					}
				});
			});
		};
     
        /**
		 * 新增合同
		 */
		$scope.addContract = function() {
			//新建新增合同弹出框
			$scope.$openDialog("addDialog", {
				title : "新增合同信息",
				width : 600,
				height : 480,
				href : "tpls/deviceManage/informationManage/contract-operate.html"
			}, true);
			/**
			 * 新增保存
			 */
			$scope.$setParam("saveData", function(data) {
				//后台保存数据
				$scope.$ajaxRequest({
					url : $scope.$restRoot + "device/contractManage/addContract",
					params : data,
					method : "post",
					success : function(data) {
						$scope.$getDialog("addDialog").dialog("close");
						$scope.$ajaxRequest({
							url : $scope.$restRoot + "device/contractManage/queryAllContract",
							params : {},
							method : "post",
							success : function(data) {
								$scope.$("#contract").combobox("loadData", data);
							},
							fail : function(errMsg) {
								$.messager.alert("提示", "初始化合同失败！");
							}
						});
					},
					fail : function(errMsg) {
						$.messager.alert("提示", errMsg + ",添加失败！");
					}
				});
			});
		};
       
        /**
         * 新增厂商
         */
        $scope.addCompany = function(){
            //建立弹出框
            $scope.$openDialog("addDialog",{
                title : "新增厂商信息",
                width : 450,
                height : 380,
                href : "tpls/deviceManage/informationManage/company-operate.html"
            },true);
            /**
             * 新增保存
             */
            $scope.$setParam("saveData",function(data) {
                //后台保存数据
                $scope.$ajaxRequest({
                    url: $scope.$restRoot+"device/companyManage/addCompany",
                    params: data,
                    method: "post",
                    success: function(data){
                        $scope.$getDialog("addDialog").dialog("close");
                        $scope.$ajaxRequest({
				            url:$scope.$restRoot+"device/companyManage/queryCompany",
				            params:{},
				            method:"post",
				            success:function(data){
				                $scope.$("#contractorId").combobox("loadData",data);
				            },
				            fail:function(errMsg){
				                $.messager.alert("提示","初始化厂商失败！");
				            }
				        });
                    },
                    fail: function(errMsg){
                        $.messager.alert("提示",errMsg);
                    }
                });
            });
        };
        //添加点位
		$scope.addSite = function(){
			$scope.$openDialog("addDialog", {
                title : "新增点位",
                height : 600,
                width : 800,
                href : 'tpls/sysManagement/roadNetworkMessage/point-segment-add.html'
            });
            //保存点位信息
            $scope.$setParam("saveData", function(data) {
                $scope.$ajaxRequest({
                    url : $scope.$restRoot + "device/site/addSite",
                    params : {jsonSitelString:JSON.stringify(data)},
                    success : function(data) {
                        //关闭窗口
                        $scope.$getDialog("addDialog").dialog("close");
                        $.messager.alert("提示","添加点位相关信息成功！");
                        var roadId = $scope.$("#roadId").textbox("getValue");
						var orgId = $scope.$("#orgId").textbox("getValue");
						if(roadId != "" || orgId != ""){
							var datas = {};//存机构或道路
							datas.roadId = roadId;
							datas.orgId = orgId;
							$scope.$ajaxRequest({
				        		url: $scope.$restRoot+'device/site/querySites',
				        		params: datas,
				        		success: function(data){
				        			if(data!= undefined){//如果返回数据，加载数据，并清空之前选择的点位	        				
					        			$scope.$("#siteId").combobox("loadData",data);
				            		}
			                    },
			                });
			             }
                    },
                    fail : function(errMsg){
	                	$.messager.alert("提示","添加点位相关信息失败！");
	                }
                });
            });
		};
		
        /**
         * 保存操作
         */
        $scope.saveOnly = function(){
        	if($scope.$("#derictionName").combobox("getValues").length != 0){
            	var sectionIdListStr = $scope.$("#derictionName").combobox("getValues").join(",");
            	$scope.$("#derictionName").combobox("setValue",sectionIdListStr);
            }
            if($scope.$("#form").form("validate")){
            	$scope.$updateData("formData");
            	trimObject($scope.formData);//对对象中的每个元素进行trim操作
            	$scope.formData.oldDeviceSysNbr = oldDeviceSysNbr;//编辑时原先的设备编号
            	$scope.formData.deviceSysNbr = $scope.$("#deviceSysNbr").textbox("getValue");
				$scope.formData.deviceName = $scope.$("#deviceName").textbox("getValue");
            	//设备基本信息保存到数据库todo
            	$scope.saveData($scope.formData);
            }
        };
        /** 
         *保存并下一步
         */
        $scope.saveAndNext = function(){
            //设备基本信息保存到数据库todo
        	if($scope.$("#derictionName").combobox("getValues").length != 0){
            	var sectionIdListStr = $scope.$("#derictionName").combobox("getValues").join(",");
            	$scope.$("#derictionName").combobox("setValue",sectionIdListStr);
            }
          
            var remark = $scope.remark;
            $scope.$updateData("formData");
           
            if(remark == "ADD" && $scope.$("#form").form("validate")){
            	trimObject($scope.formData);//对对象中的每个元素进行trim操作
            	$scope.formData.deviceSysNbr = $scope.$("#deviceSysNbr").textbox("getValue");
				$scope.formData.deviceName = $scope.$("#deviceName").textbox("getValue");
            	$scope.$ajaxRequest({
	                url : $scope.$restRoot+"device/deviceConfig/addDeviceInfo",
	                params : $scope.formData,
	                success : function(data){
		                if(data != "nbrError" && data != "keyError" && data != "videoNbrError"){
							$.messager.alert("提示","添加基本信息成功！");
							$scope.$(".button-save").linkbutton('disable').removeAttr('cy-click');
						    $scope.$setParam("deviceId1",data);//传递新增设备的ID相机信息页面
						    $scope.$setParam("deviceId3",data);//传递新增设备的ID到图片页面
						    $scope.$setParam("siteId",$scope.$("#siteId").textbox("getValue"));//传递新增设备点位的ID
						    //检定tab页可用
		                    $scope.deviceSysConfigTabs.tabs('enableTab', 1);
		                    $scope.deviceSysConfigTabs.tabs('enableTab', 3);
		                    //$scope.deviceSysConfigTabs.tabs('select', 1);
		                   
						}else if(data == "nbrError"){
							$.messager.alert("提示","设备编号已存在，请重新输入！");
    	       	   	   		return false;
						}
	                },
	                fail : function(errMsg){
	                    $.messager.alert("提示","添加基本信息失败！");
	                }
	            });
            }else if(remark == "update" && $scope.$("#form").form("validate")){
            	trimObject($scope.formData);//对对象中的每个元素进行trim操作
            	$scope.formData.oldDeviceSysNbr = oldDeviceSysNbr;//编辑时原先的设备编号
            	$scope.$ajaxRequest({
            		url: $scope.$restRoot+'device/deviceConfig/updateDeviceInfo',
            		params: $scope.formData,
            		method: 'post',
            		success: function(data){
            			if(data == 1){
							$.messager.alert("提示","修改成功!");
						}else if(data == 0){
							$.messager.alert("提示","设备编号已存在，请重新输入！");
       	   	   				return false;
						}
            		},
            		fail: function(errMsg){
            			$.messager.alert("提示","修改失败!");
            		}
            	});
            }
        };
        //根据点位ID查询断面的方向
        $scope.$('#siteId').combobox({
		    onChange:function(newValue,oldValue){
		    	//根据点位生成设备名称
				if($scope.remark == 'ADD'){
					var deviceName = $scope.$('#siteId').combobox('getText');
					$scope.$('#deviceName').textbox('setValue',deviceName + $scope.$getCodeName("400",$scope.deviceType));
				}
		    	$scope.$("#derictionName").textbox("setValue","");//清空方向名称值
		    	$scope.$("#derictionName").combobox("loadData",[]);
		       	var siteId = $scope.$("#siteId").textbox("getValue");
		    	if(!siteId || siteId != ''){
		    		$scope.$ajaxRequest({
		        		url: $scope.$restRoot+'device/deviceConfig/querySectionBySiteId',
		        		params: {siteId:siteId},
		        		success: function(data){
		        			if(data.length != 0){
		        				$scope.$("#derictionName").combobox("loadData",data);
		        				$scope.$setParam("directionData",data);//传递断面方向类型到相机页面
		        			}
				   		},
		        		fail: function(errMsg){
		        			$.messager.alert("提示","方向加载失败！");
		        		}	
		        	});	
		    	}
		    }
		});
		//清空方向名称值
		$scope.$('#derictionName').combobox({
			onChange:function(newValue,oldValue){
		    	var value=$scope.$("#derictionName").textbox("getText");
		    	while(value.startWith(",")){
		    		value=value.substring(1,value.length);
		    	}
		    	$scope.$("#derictionName").textbox("setText",value);
		   },
		   //成功加载时,再次清空
		   onLoadSuccess : function(){
		    	var value=$scope.$("#derictionName").textbox("getText");
		    	while(value.startWith(",")){
		    		value=value.substring(1,value.length);
		    	}
		    	$scope.$("#derictionName").textbox("setText",value);
		   }
		 });
		//根据机构加载点位或加载相关视频
		$scope.getSiteByOrg = function(){
			//根据所选机构自动生成设备编号
			if ($scope.remark == 'ADD'  && $scope.certificationUnregistered != 'certificationUnregistered') {
				if(newValue == ""){
					$scope.$('#deviceSysNbr').textbox('setValue',null);
				}else{
					var orgId = $scope.$('#orgId').textbox('getValue');
					//根据机构ID获取机构编码
					$scope.$ajaxRequest({
						url : $scope.$restRoot + 'sysCfg/org/queryOrgInfoById',
						params : {orgId : orgId},
						method : 'post',
						success : function(org) {
							//查询该机构下该类型的设备有多少
							$scope.$ajaxRequest({
								url : $scope.$restRoot + 'device/deviceConfig/queryDeviceByOrgId',
								params : {orgId : orgId, deviceType : $scope.deviceType},
								method : 'post',
								success : function(data) {
									var code = "";//存储设备编号后四位
									if(data != ""){
										var deviceSysNbr = data.split(",");//该机构下所有卡口设备的后四位设备编号数组
										var deviceSysNbrMax = parseInt(deviceSysNbr[deviceSysNbr.length]);
										if(deviceSysNbrMax + 1 <= 9999){
											if(deviceSysNbrMax >= 0 && deviceSysNbrMax < 9){
												code = "000" + (deviceSysNbrMax + 1).toString();
											}else if(deviceSysNbrMax >= 9 && deviceSysNbrMax < 99){
												code = "00" + (deviceSysNbrMax + 1).toString();
											}else if(deviceSysNbrMax >= 99 && deviceSysNbrMax < 999){
												code = "0" + (deviceSysNbrMax + 1).toString();
											}else if(deviceSysNbrMax >= 999 && deviceSysNbrMax < 9999){
												code = (deviceSysNbrMax + 1).toString();
											}
										}else{
											while(true){
												code = parseInt(Math.random()*9999+1).toString();//取0到9999之前的随机整数 
												if(deviceSysNbr.indexOf(code) == -1){
													break;
												}
											}
											if(parseInt(code) >= 0 && parseInt(code) < 9){
												code = "000" + code;
											}else if(parseInt(code) >= 9 && parseInt(code) < 99){
												code = "00" + code;
											}else if(parseInt(code) >= 99 && parseInt(code) < 999){
												code = "0" + code;
											}
										}
									}else{
										code = "0000";
									}
									var orgCode = org.orgCode + $scope.deviceType + code;
									$scope.$('#deviceSysNbr').textbox('setValue',orgCode);
								}
							});
						}
					});
				}
			}
			$scope.$("#roadId").textbox("clear");
			$scope.$("#siteId").combobox("clear");
			
			var roadId = $scope.$("#roadId").textbox("getValue"); 
			var orgId = $scope.$("#orgId").textbox("getValue");
			var datas = {};//存机构或道路
			datas.roadId = roadId;
			datas.orgId = orgId;
			$scope.$ajaxRequest({
        		url: $scope.$restRoot+'device/site/querySites',
        		params: datas,
        		success: function(data){
        			if(data.length != 0){
        				$scope.$("#siteId").combobox("loadData",data);
        			}else{
						$scope.$("#siteId").combobox("loadData",[]);//加载点位为空
					}
					//根据机构ID查询加载关联视频
        			var privCode = $scope.$getOrgPrivCode(orgId);//根据机构ID查机构过滤代码
		    		$scope.$ajaxRequest({
			            url:$scope.$restRoot + "device/deviceConfig/queryRelevanceDevice",
			            params:{orgPrivilegeCode : privCode},
			            method:"post",
			            success:function(data){
			            	
			            },
			            fail:function(errMsg){
			                $.messager.alert("提示","初始关联设备失败，请重新打开此页面！");
			            }
			        });
        		},
        		fail: function(errMsg){
        			$.messager.alert("提示","点位加载失败！");
        		}	
        	});	
		};
		
		
		/**
		 *联动
		 */
		//机构和道路的联动
		$scope.getRoadByOrg = function(id,text,attribute){
			var orgId = $scope.$("#orgId").textbox("getValue");
			var privCode = $scope.$getOrgPrivCode(orgId);
			if(!orgId || orgId == ''){
				return true;
			}
			if(attribute.nodeType == "road"){
				var orgPrivCodes = attribute.orgPrivCode.split(",");
				for(var i in orgPrivCodes){
					if(orgPrivCodes[i].startWith(privCode)){
						return true;
					}
				}
				return false;
			}else{
				return true;
			}
		};
	}); 
</script>
<style >
	#eventBase .th {
		text-align: right;
		width: 95px;
	}
	#eventBase .td {
		width: 177px;
	}
	#eventBase .td input{
		width: 177px;
	}
	#eventNetwork .th {
		text-align: right;
		width: 80px;
	}
	#eventDevice .td {
		width: 190px;
	}
	#eventDeviceTr .td {
		width: 190px;
	}
	#eventDeviceFunction .th {
		text-align: right;
		width: 110px;
	}
	#deviceSysInfo .panel_title{
        position: relative;
        width: 60px;
    }
</style>

